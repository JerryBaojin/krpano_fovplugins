/*
	krpano iOS 4.2 gyroscope script
	by Aldo Hoeben / fieldofview.com
	contributions by 
		Sjeiti / ronvalstar.nl
		Klaus / krpano.com
		
	https://github.com/fieldOfView/krpano_fovplugins/gyro
	This software can be used free of charge and the source code is available under a Creative Commons Attribution license:
		http://creativecommons.org/licenses/by/3.0/		
*/
var krpanoplugin=function(){var p=this,x=null,e=null,s,y=false,b=0,v=false,q=0.5,w=false,z=0,o=0,u=0,k=0,g=0,m=0,c=Math.PI/180;p.registerplugin=function(B,A,C){x=B;e=C;if(x.version<"1.0.8.14"||x.build<"2011-03-30"){x.trace(3,"gyro plugin - too old krpano version (min. 1.0.8.14)");return}if(!!window.DeviceOrientationEvent){window.addEventListener("deviceorientation",i)}e.registerattribute("available",false,function(D){},function(){return s});e.registerattribute("enabled",true,function(D){t(D)?l():d()},function(){return y});e.registerattribute("velastic",0,function(D){b=Math.max(Math.min(Number(D),1),0);x.trace(0,(1-Math.pow(b,2)))},function(){return b});e.registerattribute("camroll",false,function(D){v=t(D)},function(){return v});e.registerattribute("friction",0.5,function(D){q=Math.max(Math.min(Number(D),1),0)},function(){return q});e.enable=l;e.disable=d;e.toggle=r};p.unloadplugin=function(){window.removeEventListener("deviceorientation",i);d();e=null;x=null};function l(){if(s===undefined){y=true;return}if(s&&!y){window.addEventListener("deviceorientation",h,true);x.control.layer.addEventListener("touchstart",j,true);x.control.layer.addEventListener("touchend",n,true);x.control.layer.addEventListener("touchcancel",n,true);y=true;z=-window.orientation;o=0;u=0;k=0}else{y=false}}function d(){if(isDeviceEnabled&&y){window.removeEventListener("deviceorientation",h);x.control.layer.removeEventListener("touchstart",j);x.control.layer.removeEventListener("touchend",n);x.control.layer.removeEventListener("touchcancel",n)}y=false}function r(){if(y){d()}else{l()}}function i(A){s=true;window.removeEventListener("deviceorientation",i);if(y){y=false;l()}}function j(A){w=true}function n(A){w=false}function h(A){if(!w&&y){var C=a(new Object({yaw:A.alpha*c,pitch:A.beta*c,roll:A.gamma*c})),F=f(C.yaw/c),B=C.pitch/c,G=F,I,J=x.view.hlookat,H=x.view.vlookat,E=x.view.camroll,K=J-u,D=H-k;if(v){g=f(180+Number(window.orientation)-C.roll/c)}if(Math.abs(B)>70){G=A.alpha;switch(window.orientation){case 0:if(B>0){G+=180}break;case 90:G+=90;break;case -90:G+=-90;break;case 180:if(B<0){G+=180}break}G=f(G);if(Math.abs(G-F)>180){G+=(G<F)?360:-360}I=Math.min(1,(Math.abs(B)-70)/10);F=F*(1-I)+G*I;g*=(1-I)}z+=K;o+=D;if(Math.abs(B+o)>90){o=(B+o>0)?(90-B):(-90-B)}u=f(-F-180+z);k=Math.max(Math.min((B+o),90),-90);if(Math.abs(u-J)>180){J+=(u>J)?360:-360}u=(1-q)*u+q*J;k=(1-q)*k+q*H;if(Math.abs(g-E)>180){E+=(g>E)?360:-360}g=(1-q)*g+q*E;x.view.hlookat=f(u);x.view.vlookat=k;x.view.camroll=f(g);if(o!=0&&b>0){if(D==0){if(b==1){o=0;m=0}else{m=1-((1-m)*x.control.touchfriction);o*=1-(Math.pow(b,2)*m);if(Math.abs(o)<0.1){o=0;m=0}}}else{m=0}}}}function a(C){var J,G,B,A=Math.cos(C.yaw),F=Math.sin(C.yaw),E=Math.cos(C.pitch),I=Math.sin(C.pitch),D=Math.cos(C.roll),H=Math.sin(C.roll);matrix=new Array(F*H-A*I*D,-A*E,A*I*H+F*D,E*D,-I,-E*H,F*I*D+A*H,F*E,-F*I*H+A*D);if(matrix[3]>0.9999){J=Math.atan2(matrix[2],matrix[8]);B=Math.PI/2;G=0}else{if(matrix[3]<-0.9999){J=Math.atan2(matrix[2],matrix[8]);B=-Math.PI/2;G=0}else{J=Math.atan2(-matrix[6],matrix[0]);G=Math.atan2(-matrix[5],matrix[4]);B=Math.asin(matrix[3])}}return new Object({yaw:J,pitch:B,roll:G})}function f(A){A=A%360;return(A<=180)?A:A-360}function t(A){return(String("yesontrue1").indexOf(String(A).toLowerCase())>=0)}};
