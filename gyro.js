/*
gyro plugin for KRPanoJS and iOS4.2+
by Aldo Hoeben / fieldOfView.com
contributions by 
	Sjeiti / ronvalstar.nl
	Klaus / krpano.com
	
http://fieldofview.github.com/krpano_fovplugins/gyro/plugin.html
This software can be used free of charge and the source code is available under a Creative Commons Attribution license:
	http://creativecommons.org/licenses/by/3.0/	
*/
var krpanoplugin=function(){var o=this,u=null,d=null,k=false,q,v=false,b=0,w=false,s=false,g=0.5,t=false,h=false,n=null;hOffset=0,vOffset=0,hLookAt=0,vLookAt=0,camRoll=0,vElasticSpeed=0,degRad=Math.PI/180;o.registerplugin=function(z,x,A){u=z;d=A;if(u.version<"1.0.8.14"||u.build<"2011-03-30"){u.trace(3,"gyro plugin - too old krpano version (min. 1.0.8.14)");return}k=u._have_top_access;if(k===undefined){k=false;try{if(top&&top.document){k=true}}catch(y){}}if(!!window.DeviceOrientationEvent){window.addEventListener("deviceorientation",i)}d.registerattribute("available",false,function(B){},function(){return q});d.registerattribute("enabled",true,function(B){r(B)?l():c()},function(){return v});d.registerattribute("velastic",0,function(B){b=Math.max(Math.min(Number(B),1),0)},function(){return b});d.registerattribute("vrelative",false,function(B){w=r(B)},function(){return w});d.registerattribute("camroll",false,function(B){s=r(B)},function(){return s});d.registerattribute("friction",0.5,function(B){g=Math.max(Math.min(Number(B),1),0)},function(){return g});d.registerattribute("onavailable",null);d.enable=l;d.disable=c;d.toggle=p};o.unloadplugin=function(){window.removeEventListener("deviceorientation",i);c();d=null;u=null};function l(){h=false;n=null;if(q===undefined){v=true;return}if(q&&!v){window.addEventListener("deviceorientation",f,true);u.control.layer.addEventListener("touchstart",j,true);u.control.layer.addEventListener("touchend",m,true);u.control.layer.addEventListener("touchcancel",m,true);v=true;hOffset=-(k?top.orientation:window.orientation);vOffset=0;hLookAt=0;vLookAt=0;camRoll=u.view.camroll}else{v=false}}function c(){if(q&&v){window.removeEventListener("deviceorientation",f,true);u.control.layer.removeEventListener("touchstart",j);u.control.layer.removeEventListener("touchend",m);u.control.layer.removeEventListener("touchcancel",m)}if(s){u.call("tween(view.camroll,0)")}v=false}function p(){if(v){c()}else{l()}}function i(x){q=true;window.removeEventListener("deviceorientation",i);if(v){v=false;l()}if(d.onavailable!=null){u.call(d.onavailable,d)}}function j(x){t=true}function m(x){t=false}function f(x){if(!t&&v){var D=k?top.orientation:window.orientation,z=a({yaw:x.alpha*degRad,pitch:x.beta*degRad,roll:x.gamma*degRad}),C=e(z.yaw/degRad),y=z.pitch/degRad,E=C,G,H=u.view.hlookat,F=u.view.vlookat,B=u.view.camroll,I=H-hLookAt,A=F-vLookAt;if(!h){if(n==null){n=z}else{if(z.yaw!=n.yaw||z.pitch!=n.pitch||z.roll!=n.roll){n=null;h=true;if(w){vOffset=-y}}}return}if(s){camRoll=e(180+Number(D)-z.roll/degRad)}if(Math.abs(y)>70){E=x.alpha;switch(D){case 0:if(y>0){E+=180}break;case 90:E+=90;break;case -90:E+=-90;break;case 180:if(y<0){E+=180}break}E=e(E);if(Math.abs(E-C)>180){E+=(E<C)?360:-360}G=Math.min(1,(Math.abs(y)-70)/10);C=C*(1-G)+E*G;camRoll*=(1-G)}hOffset+=I;vOffset+=A;if(Math.abs(y+vOffset)>90){vOffset=(y+vOffset>0)?(90-y):(-90-y)}hLookAt=e(-C-180+hOffset);vLookAt=Math.max(Math.min((y+vOffset),90),-90);if(Math.abs(hLookAt-H)>180){H+=(hLookAt>H)?360:-360}hLookAt=(1-g)*hLookAt+g*H;vLookAt=(1-g)*vLookAt+g*F;if(Math.abs(camRoll-B)>180){B+=(camRoll>B)?360:-360}camRoll=(1-g)*camRoll+g*B;u.view.hlookat=e(hLookAt);u.view.vlookat=vLookAt;u.view.camroll=e(camRoll);if(vOffset!=0&&b>0){if(A==0){if(b==1){vOffset=0;vElasticSpeed=0}else{vElasticSpeed=1-((1-vElasticSpeed)*u.control.touchfriction);vOffset*=1-(Math.pow(b,2)*vElasticSpeed);if(Math.abs(vOffset)<0.1){vOffset=0;vElasticSpeed=0}}}else{vElasticSpeed=0}}}}function a(z){var H,D,y,x=Math.cos(z.yaw),C=Math.sin(z.yaw),B=Math.cos(z.pitch),G=Math.sin(z.pitch),A=Math.cos(z.roll),E=Math.sin(z.roll);var F=[C*E-x*G*A,-x*B,x*G*E+C*A,B*A,-G,-B*E,C*G*A+x*E,C*B,-C*G*E+x*A];if(F[3]>0.9999){H=Math.atan2(F[2],F[8]);y=Math.PI/2;D=0}else{if(F[3]<-0.9999){H=Math.atan2(F[2],F[8]);y=-Math.PI/2;D=0}else{H=Math.atan2(-F[6],F[0]);D=Math.atan2(-F[5],F[4]);y=Math.asin(F[3])}}return{yaw:H,pitch:y,roll:D}}function e(x){x=x%360;return(x<=180)?x:x-360}function r(x){return(String("yesontrue1").indexOf(String(x).toLowerCase())>=0)}};