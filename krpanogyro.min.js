/*
	krpano gyroscope script for iOS 4.2 
	by Aldo Hoeben / fieldofview.com
	contributions by Sjeiti / ronvalstar.nl
	
	https://github.com/fieldOfView/krpano_gyro
	
	This software is licensed under the CC-GNU GPL version 2.0 or later
	http://creativecommons.org/licenses/GPL/2.0/
*/
if(!this.krpanoGyro){var krpanoGyro=function(y){var i=!!window.DeviceOrientationEvent,u,d,p={enable:k,disable:f,toggle:q,deviceAvailable:function(){return i},enabled:function(){return w},setadaptivev:m,setAdaptiveV:m,adaptiveV:function(){return h},toString:function(){return"[object krpanoGyro]"}},w=false,h=false,t=false,b=0,e=0,r=0,v=0,c=Math.PI/180;if(y){d=(typeof(y)=="object")?y.pid:y}else{d="krpanoSWFObject"}if(i){s()}function s(){u=document.getElementById(d);if(u){x()}else{setTimeout(s,100)}}function x(){b=u.get("view.hlookat");e=u.get("view.vlookat");u.set("gyro",p);u.set("gyro.deviceAvailable",true);u.set("gyro.adaptiveV",h);u.set("gyro.enabled",w);k()}function k(){if(i&&!w){window.addEventListener("deviceorientation",g,true);u.addEventListener("touchstart",j,true);u.addEventListener("touchend",l,true);u.addEventListener("touchcancel",l,true);w=true;if(u){u.set("gyro.enabled",true)}}return w}function f(){if(i&&w){window.removeEventListener("deviceorientation",g);u.removeEventListener("touchstart",j);u.removeEventListener("touchend",l);u.removeEventListener("touchcancel",l);w=false;if(u){u.set("gyro.enabled",false)}}return w}function q(){if(w){return f()}else{return k()}}function m(o){switch(o){case 0,"0",false,"false":h=false;break;case 1,"1",true,"true":h=true;break;default:h=!h;break}if(u){u.set("gyro.adaptiveV",h)}}function j(o){t=true}function l(o){t=false}function g(B){if(!t&&w){var o=a(new Object({yaw:B.alpha*c,pitch:B.beta*c,roll:B.gamma*c})),D=o.yaw/c,C=o.pitch/c,A=D,z;if(Math.abs(C)>70){A=B.alpha;switch(window.orientation){case 0:if(C>0){A+=180}break;case 90:A+=90;break;case -90:A+=-90;break}A=A%360;if(Math.abs(A-D)>180){A+=(A<D)?360:-360}z=Math.min(1,(Math.abs(C)-70)/10);D=D*(1-z)+A*z}b+=u.get("view.hlookat")-r;e+=u.get("view.vlookat")-v;if(Math.abs(C+e)>90){e=(C+e>0)?(90-C):(-90-C)}r=(-D-180+b)%360;v=Math.max(Math.min((C+e),90),-90);u.call("lookat("+r+","+v+")");n()}}function n(){if(e!=0&&h){e*=0.98;if(Math.abs(e)<0.1){e=0}}}function a(A){var H,E,z,o=Math.cos(A.yaw),D=Math.sin(A.yaw),C=Math.cos(A.pitch),G=Math.sin(A.pitch),B=Math.cos(A.roll),F=Math.sin(A.roll);matrix=new Array(D*F-o*G*B,-o*C,o*G*F+D*B,C*B,-G,-C*F,D*G*B+o*F,D*C,-D*G*F+o*B);if(matrix[3]>0.9999){H=Math.atan2(matrix[2],matrix[8]);z=Math.PI/2;E=0}else{if(matrix[3]<-0.9999){H=Math.atan2(matrix[2],matrix[8]);z=-Math.PI/2;E=0}else{H=Math.atan2(-matrix[6],matrix[0]);E=Math.atan2(-matrix[5],matrix[4]);z=Math.asin(matrix[3])}}return new Object({yaw:H,pitch:z,roll:E})}return p}};

// Comment out or edit the following line if you want to use a custom krpano object or a different object name
var gyro = krpanoGyro();