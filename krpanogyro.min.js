/*
	krpano gyroscope script for iOS 4.2 
	by Aldo Hoeben / fieldofview.com
	contributions by Sjeiti / ronvalstar.nl
	
	https://github.com/fieldOfView/krpano_gyro
	
	This software is licensed under the CC-GNU GPL version 2.0 or later
	http://creativecommons.org/licenses/GPL/2.0/
*/
if(!this.krpanoGyro){var krpanoGyro=function(y){var i=!!window.DeviceOrientationEvent;var d;if(y){d=(typeof(y)=="object")?y.pid:y}else{d="krpanoSWFObject"}var t;var n={enable:k,disable:f,toggle:p,deviceAvailable:function(){return i},enabled:function(){return w},setadaptivev:l,setAdaptiveV:l,adaptiveV:function(){return h},toString:function(){return"[object krpanoGyro]"}};var w=false;var h=false;var s=false;var b=0;var e=0;var q=0;var u=0;var c=Math.PI/180;if(i){r()}function r(){t=document.getElementById(d);if(t){x()}else{setTimeout(r,100)}}function x(){b=t.get("view.hlookat");e=t.get("view.vlookat");m();k();t.set("gyro",n);t.set("gyro.deviceAvailable",true)}function k(){if(i&&!w){window.addEventListener("deviceorientation",g,true);t.addEventListener("touchstart",j,true);t.addEventListener("touchend",v,true);t.addEventListener("touchcancel",v,true);w=true;t.set("gyro.enabled",true)}return w}function f(){if(i&&w){window.removeEventListener("deviceorientation",g);t.removeEventListener("touchstart",j);t.removeEventListener("touchend",v);t.removeEventListener("touchcancel",v);w=false;t.set("gyro.enabled",false)}return w}function p(){if(w){return f()}else{return k()}}function l(o){if(i){switch(o){case 0,"0",false,"false":h=false;break;case 1,"1",true,"true":h=true;break;default:h=!h;break}t.set("gyro.adaptiveV",h);m()}}function j(o){s=true}function g(z){if(!s&&w){b+=t.get("view.hlookat")-q;e+=t.get("view.vlookat")-u;var o=a(new Object({yaw:z.alpha*c,pitch:z.beta*c,roll:z.gamma*c}));var B=o.yaw/c;var A=o.pitch/c;if(Math.abs(A)>70){altyaw=z.alpha;switch(window.orientation){case 0:if(A>0){altyaw+=180}break;case 90:altyaw+=90;break;case -90:altyaw+=-90;break}altyaw=altyaw%360;if(Math.abs(altyaw-B)>180){altyaw+=(altyaw<B)?360:-360}factor=Math.min(1,(Math.abs(A)-70)/10);B=B*(1-factor)+altyaw*factor}if(Math.abs(A+e)>90){e=(A+e>0)?(90-A):(-90-A)}q=(-B-180+b)%360;u=Math.max(Math.min((A+e),90),-90);t.call("lookat("+q+","+u+")");m()}}function v(o){m();s=false}function m(){if(e!=0&&h){e*=0.98;if(Math.abs(e)<0.1){e=0}}}function a(A){var z=Math.cos(A.yaw);var D=Math.sin(A.yaw);var C=Math.cos(A.pitch);var G=Math.sin(A.pitch);var B=Math.cos(A.roll);var F=Math.sin(A.roll);matrix=new Array(D*F-z*G*B,-z*C,z*G*F+D*B,C*B,-G,-C*F,D*G*B+z*F,D*C,-D*G*F+z*B);var H;var E;var o;if(matrix[3]>0.9999){H=Math.atan2(matrix[2],matrix[8]);o=Math.PI/2;E=0}else{if(matrix[3]<-0.9999){H=Math.atan2(matrix[2],matrix[8]);o=-Math.PI/2;E=0}else{H=Math.atan2(-matrix[6],matrix[0]);E=Math.atan2(-matrix[5],matrix[4]);o=Math.asin(matrix[3])}}return new Object({yaw:H,pitch:o,roll:E})}return n}};

// Comment out or edit the following line if you want to use a custom krpano object or a different object name
var gyro = krpanoGyro();